#!/bin/zsh

export CRUSH_CONFIG="$HOME/.crush"

if [ -z "$CRUSH_MODEL" ]; then
  export CRUSH_MODEL=claude-sonnet-4.5
fi

if [ -z "$CRUSH_SESSION_DIR" ]; then
  export CRUSH_SESSION_DIR="$CRUSH_CONFIG/state/$RANDOM"
fi

mkdir -p "$CRUSH_SESSION_DIR"

function _shell_suggest() {
  crush run "this is a question about a command only; i am not asking you to do anything except answer the question $*"
}

function _autopilot() {
  crush run "PRIMARY TASK: $*. If there is a problem, fix it. After completing the primary task, confirm completion. BACKGROUND TASKS: $(_autopilot_prompt)"
}

# Wrapper functions that disable globbing internally
function a() {
  setopt localoptions noglob
  _autopilot "$@"
}

function autopilot() {
  setopt localoptions noglob
  _autopilot "$@"
}

alias '??'='noglob _shell_suggest'

function _autopilot_prompt() {
cat <<EOF
If $CRUSH_SESSION_DIR/context exists, read it for background info.
If $CRUSH_SESSION_DIR/state exists, read it for previous state.
Never modify $CRUSH_SESSION_DIR/context.
While running I might want to send you a note so look for a file in the directory you are running in called autopilot.note. Once you have read it delete it.
After completing the primary task, log actions to $CRUSH_SESSION_DIR/state with timestamps.
For long-running commands, use background execution and log PIDs to $CRUSH_SESSION_DIR/pids.
Use shellcheck for shell scripts and cspell for spelling (add #cSpell:ignore or // cSpell:ignore for correct words).
Security is critical.
When the user specifies file paths or patterns, they will use the noglob command prefix which allows shell completion but prevents glob expansion - treat their input literally.
EOF
}
